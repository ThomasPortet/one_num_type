pred collect i:list term, i:list term, i:term, i:list term, o:list term.

collect KnownOps IgnOps (app [Op | Args]) AccI AccO :-
    std.mem! KnownOps Op,
    std.fold Args AccI (collect KnownOps IgnOps) AccO.

collect _ IgnOps (app [Op | _]) A A :-
    std.mem! IgnOps Op.

collect KnownOps IgnOps (app [_ | Args]) AccI AccO :-
    std.filter Args (has_type_R) ArgsR,
    std.append AccI ArgsR Acc1,
    std.fold Args Acc1 (collect KnownOps IgnOps) AccO.

collect _ _ _ A A.

pred has_type_R i:term.

has_type_R T :-
    coq.typecheck T {{R}} ok.

pred sub_ringable_r i:term i:list term o:list term.

sub_ringable_r T L0 L  :-
    collect [{{ Rplus }}, {{ Rmult }}, {{ Ropp }}, {{ R1 }}, {{ R0 }}, {{Rminus}}] [{{IZR}}] T [T|L0] L.

pred sub_fieldable_r i:term i:list term o:list term.

sub_fieldable_r T L0 L  :-
    collect [{{ Rplus }}, {{ Rmult }}, {{ Ropp }}, {{ R1 }}, {{ R0 }}, {{Rminus}}, {{Rdiv}}, {{pow}}] [{{IZR}}] T [T|L0] L.

func all_vars term, list term -> list term.

all_vars (app [_| Args]) L0 L  :-
    !, std.fold Args L0 all_vars L.

all_vars T L0 [T|L0]  :- 
    is_var T,!.

all_vars _ L L.

func is_var term.
is_var (global (const _)).


pred sub_ringable_vars i:term i:list term i:list term o:list term.

sub_ringable_vars T L0 V L  :-
    std.append V L0 L1,
    sub_ringable_r T L1 L.


pred sub_fieldable_r i:term i:list term o:list term.

sub_fieldable_r T L0 L  :-
    collect [{{ Rplus }}, {{ Rmult }}, {{ Ropp }}, {{ R1 }}, {{ R0 }}, {{Rminus}}, {{Rdiv}}, {{pow}}] [{{IZR}}] T [T|L0] L.
pred is_hyp_ge0  i:term i:prop.

is_hyp_ge0 T (def _ _ {{0 <= lp:T}} _). 
is_hyp_ge0 T (decl _ _ {{0 <= lp:T}}).

pred newHs i:list prop, i:list prop o:list (triple term term term).
newHs [] _ [].
newHs [( decl A _ {{Rnat lp:X}}) | R] Ctx [(triple H P X)|R1]  :-
    not (std.exists Ctx (is_hyp_ge0 X)),
    add_ge0 A H P,
    newHs R Ctx R1.

newHs [_| R] Ctx R1  :-
    newHs R Ctx R1.

pred add_ge0 i:term, o:term, o:term.
add_ge0 P {{(0 <= lp:X)%R}} {{Rnat_ge0 lp:X lp:P}}.


pred term->string i:term o:string.
term->string  T S7 :-
    coq.term->string T S1,
    rex.replace "-" "minus" S1 S2,
    rex.replace "\+" "plus" S2 S3,
    rex.replace "\*" "mult" S3 S4,
    rex.replace "/" "div" S4 S5,
    rex.replace "\^" "pow" S5 S6,
    rex.replace "[^a-zA-Z0-9]" "" S6 S7
    .

pred letifyge0s i:list (triple term term term) o:term.

letifyge0s [] _.

letifyge0s [triple St Prf X|Tl] (let Name St Prf Bo) :-
    term->string X N, coq.name-suffix `ge0` N Name,
    pi x \
    letifyge0s Tl (Bo x).
